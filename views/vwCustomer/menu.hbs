<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
        integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/customer/css/menu.css">
</head>

<body>
    <div class="container my-4 blueContainer">
        <!-- Search Bar -->
        <div class="sticky-search row justify-content-center mb-3">
            <div class="col-md-12 d-flex align-items-center">
                <div class="search">
                    <form action="/menu/search" method="get" class="d-flex">
                        <input type="text" name="query" class="form-control" placeholder="B·∫°n ƒëang c·∫ßn t√¨m ki·∫øm g√¨?"
                            required>
                        <button type="submit" class="btn btn-primary ml-2 custom-btn ">
                            <i class="bi bi-search"></i> T√¨m ki·∫øm
                        </button>
                    </form>
                </div>
                <!-- Cart Icon -->
                <div class="ml-3">
                    <a href="/cart" id="card-icon" class="btn btn-light custom-btn">
                        <img src="/customer/images/cart.png" alt="" style="width: 20px; height: 20px;">
                    </a>
                </div>
                <!-- Order Icon -->
                <div class="ml-3">
                    <a href="/customer/order_list" class="btn btn-light custom-btn ">
                        <img src="/customer/images/order-fulfillment 1.png" alt="Orders"
                            style="width: 20px; height: 20px;">
                    </a>
                </div>
            </div>
        </div>
        <!-- Header -->
        <div class="row align-items-center mb-4 overlay-background">
            <div class="col-5 col-sm-6  text-center logo-section">
                <div class="row">
                    <div class="col">
                        <h4 class="mt-2 delicacy-tile">DELIC <span class="acy">ACY</span></h4>
                        <p class="m-0" style="color: #5A9AD0;">Where taste meets quality</p>
                        <p class="m-0" style="color: #000000;">¬© delicacy.com | 0909336599</p>
                    </div>
                    <div class="col ">
                        <img src="/customer/images/poster2 1.png" class="img-fluid rounded" alt="DELICACY Logo"
                            style="width: 150px; height: 200px;">
                    </div>
                </div>
            </div>
            <div class="col-7 col-sm-6 text-center info-section ">
                <div class="row">
                    <div class="col-5 col-sm-6" style="display: flex; justify-content: center; align-items: center;">
                        <h2 id="title-menu"> The<br> <br>
                            Coffee<br><br>
                            House
                        </h2>
                    </div>
                    <div class="col-7 col-sm-6 ">
                        <p style="color: #245ed1;">
                            100 nƒÉm c√† ph√™ h·ªØu h·∫°n, Kh√¥ng ch·ªâ d·ª´ng l·∫°i ·ªü c√† ph√™, ch√∫ng t√¥i c√≤n mang ƒë·∫øn m·ªôt th·ª±c ƒë∆°n
                            phong ph√∫ v·ªõi c√°c m√≥n b√°nh ng·ªçt th·ªß c√¥ng v√† nh·ªØng m√≥n ƒÉn nh·∫π, ph√π h·ª£p cho nh·ªØng bu·ªïi h·ªçp m·∫∑t
                            b·∫°n b√®, l√†m vi·ªác hay th∆∞ gi√£n m·ªôt m√¨nh.
                        </p>
                        <p style="color: #000000;">
                            üìç Linh ƒê√¥ng, Th·ªß ƒê·ª©c | üìû 0123456789 | ‚úâÔ∏è thecoffeehouse@gmail.com
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Category Section -->
        <div class="text-center mb-4">
            <div class="d-flex justify-content-between">
                <p class="font-weight-bold"><strong>T·ªïng c·ªông: {{totalItems}}</strong></p>
                <button class="btn btn-primary d-flex align-items-center">
                    <i class="bi bi-grid mr-2"></i>
                    <span class="font-weight-bold">Danh m·ª•c</span>
                </button>
            </div>
            <div class="category-menu mx-auto">
                <div class="d-flex justify-content-center overflow-scroll-container">
                    {{#each categories}}
                    <div class="text-center mx-2">
                        <button class="btn btn-circle p-0 category-btn" data-category-id="{{this.category_id}}">
                            <img src="/images/{{this.image_href}}" class="rounded-circle" alt="{{this.category_name}}"
                                width="60" height="60">
                        </button>
                        <p class="mt-2 font-weight-bold">
                            <a href="/menu?category_id={{this.category_id}}">{{this.category_name}}</a>
                        </p>
                    </div>
                    {{/each}}
                </div>
            </div>
        </div>
        <script>
            function formatPrice(price) {
                return numeral(price).format('0.000') + ' VNƒê';
            }

            // L·∫Øng nghe s·ª± ki·ªán click v√†o n√∫t category
            document.querySelectorAll('.category-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const categoryId = this.getAttribute('data-category-id');
                    window.history.pushState(null, '', `/menu?category_id=${categoryId}`);
                    window.location.reload();
                    fetch(`/menu?category_id=${categoryId}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Failed to load data');
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('Received Data:', data); // Ki·ªÉm tra d·ªØ li·ªáu
                            if (data && data.groupedItems) {
                                const productSection = document.querySelector('.product-section');
                                let productHtml = '';

                                // X·ª≠ l√Ω d·ªØ li·ªáu tr·∫£ v·ªÅ v√† c·∫≠p nh·∫≠t giao di·ªán
                                data.groupedItems.forEach(category => {
                                    productHtml += `<div class="product-category"><h3>${category.category_name}</h3><div class="products">`;
                                    category.items.forEach(item => {
                                        sale_price = formatPrice(item.price);
                                        productHtml += `
                                        <div class="product-item">
                                            <img src="${item.image_href}" alt="${item.name}">
                                            <p>${item.name}</p>
                                            <p>${sale_price}</p> <!-- Th√™m gi√° n·∫øu c·∫ßn -->
                                        </div>
                                    `;
                                    });
                                    productHtml += `</div></div>`;
                                });

                                // C·∫≠p nh·∫≠t ph·∫ßn s·∫£n ph·∫©m v·ªõi n·ªôi dung m·ªõi
                                productSection.innerHTML = productHtml;
                            } else {
                                console.error('No valid products data returned.');
                            }
                        })
                        .catch(error => {
                            console.error('Error loading products:', error);
                        });

                });
            });
        </script>

        <!-- Product Section -->
        <div class="product-section mb-5">
            {{#each groupedItems}}
            <div class="category-wrapper">
                <h3 class=" font-weight-bold">{{@key}}</h3>
                <div class="product-container overflow-x">
                    <div class="row flex-nowrap">
                        <!-- Product Card -->
                        {{#each this}}
                        <div class="col-md-3 col-sm-6 mb-2">
                            <div class="card text-center h-100 shadow-sm ">
                                <div class="image-container">
                                    <img src="/images/menu_items/{{menu_item_id}}/main.jpg" alt="{{name}}"
                                        class="card-img-top mx-auto mt-3" style="width: 100%; height: 100%;">
                                    <div class="overlay">
                                        <a href="/customer/detail/add?id={{this.menu_item_id}}"
                                            class="btn btn-light btn-sm">Xem chi ti·∫øt</a>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <p class="card-text font-weight-bold">{{this.name}}</p>
                                    <p class="card-text text-primary price-text">{{format_price sale_price}}</p>
                                    <form action="/menu/add" id="addToCartForm_{{this.menu_item_id}}" method="post"
                                        style="display: none;">
                                        <input type="hidden" name="product_id" value="{{this.menu_item_id}}">
                                        <input type="hidden" name="name" value="{{this.name}}">
                                        <input type="hidden" name="sale_price" value="{{this.sale_price}}">
                                        <input type="hidden" name="quantity" value="1">
                                        <input type="hidden" name="topping" id="hiddenToppings" value="">
                                        <input type="hidden" name="image_href" value="{{this.image_href}}">
                                    </form>

                                    <!-- N√∫t th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng -->
                                    <!-- Th√™m data-form-id v√†o n√∫t "Th√™m v√†o gi·ªè h√†ng" -->
                                    <a class="btn-add" href="#" data-form-id="addToCartForm_{{this.menu_item_id}}">
                                        <i class="fa fa-plus"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                        {{/each}}

                    </div>
                </div>
            </div>
            {{/each}}

            <!-- Footer with Action Buttons -->
            <div class="sticky-footer d-flex justify-content-between blue">
                <button class="btn btn-success btn-lg">ƒê·∫∑t h√†ng</button>
                <button class="btn btn-danger btn-lg">H·ªßy ch·ªçn</button>
            </div>
        </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/numeral.js/2.0.6/numeral.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script>
            document.querySelectorAll('.btn-add').forEach(button => {
                button.addEventListener('click', function () {
                    const formId = this.getAttribute('data-form-id');
                    const form = document.getElementById(formId);

                    // Ki·ªÉm tra xem form c√≥ t·ªìn t·∫°i kh√¥ng
                    if (!form) {
                        console.error('Form kh√¥ng t√¨m th·∫•y:', formId);
                        return;
                    }

                    // L·∫•y d·ªØ li·ªáu t·ª´ form
                    const formData = new FormData(form);

                    // Chuy·ªÉn ƒë·ªïi FormData th√†nh ƒë·ªëi t∆∞·ª£ng JavaScript
                    const formObject = {};
                    formData.forEach((value, key) => {
                        formObject[key] = value;
                    });

                    // G·ª≠i d·ªØ li·ªáu qua fetch v·ªõi JSON
                    fetch(form.action, {
                        method: form.method,
                        body: JSON.stringify(formObject),  // Chuy·ªÉn ƒë·ªëi t∆∞·ª£ng th√†nh chu·ªói JSON
                        headers: {
                            'Content-Type': 'application/json'  // ƒê·∫£m b·∫£o g·ª≠i d∆∞·ªõi d·∫°ng JSON
                        }
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`L·ªói HTTP! M√£ tr·∫°ng th√°i: ${response.status}`);
                            }
                            return response.json();  // Chuy·ªÉn ƒë·ªïi ph·∫£n h·ªìi th√†nh JSON
                        })
                        .then(data => {
                            console.log(data);  // Ki·ªÉm tra d·ªØ li·ªáu tr·∫£ v·ªÅ t·ª´ server
                            if (data.success) {
                                // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
                                Swal.fire({
                                    title: 'Th√†nh c√¥ng!',
                                    text: data.message,
                                    icon: 'success',
                                    confirmButtonText: 'OK'
                                });

                                // C·∫≠p nh·∫≠t gi·ªè h√†ng v·ªõi s·ªë l∆∞·ª£ng items v√† t·ªïng ti·ªÅn
                                if (document.getElementById('totalItems')) {
                                    document.getElementById('totalItems').textContent = data.totalItems;
                                }
                                if (document.getElementById('cartTotal')) {
                                    document.getElementById('cartTotal').textContent = formatPrice(data.cartTotal);
                                }
                            } else {
                                // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói n·∫øu kh√¥ng th√†nh c√¥ng
                                Swal.fire({
                                    title: 'L·ªói!',
                                    text: data.message,
                                    icon: 'error',
                                    confirmButtonText: 'OK'
                                });
                            }
                        })
                        .catch(error => {
                            console.error('L·ªói khi l·∫•y d·ªØ li·ªáu:', error);
                            Swal.fire({
                                title: 'L·ªói!',
                                text: 'C√≥ l·ªói x·∫£y ra khi th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng.',
                                icon: 'error',
                                confirmButtonText: 'OK'
                            });
                        });
                });
            });

            // H√†m ƒë·ªãnh d·∫°ng gi√° ti·ªÅn
            function formatPrice(price) {
                return numeral(price).format('0,0') + ' VNƒê';  // ƒê·ªãnh d·∫°ng theo ki·ªÉu s·ªë VNƒê
            }

        </script>

</body>

</html>